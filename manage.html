<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Custom Search Lists</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.11"></script>
</head>
<body>
<div id="websiteLists">
    <div v-for="wl in websiteLists">
        <h2><a v-bind:href="`https://cse.google.com/cse?cx=${wl.googleCseCreatorId}:${wl.googleCseId}`">{{ wl.name }}</a></h2>
        <p>
            {{ wl.description }}
            <span>
                [
                <a href="" v-on:click.prevent="downloadAnnotations(wl.id, wl.googleCseId, wl.googleCseCreatorId)">annotations</a>
                ]
            </span>
        </p>
    </div>
</div>
<script>
    const WEBSITES_METADATA = ['engines.json', 'engines-local.json'];

    /**
     *
     * Multi-browser file download function from
     * https://stackoverflow.com/questions/3665115/
     * @param name
     * @param content
     * @param type
     */
    function downloadFile(name, content, type) {
        let blob = new Blob([content], {type: type});
        if (window.navigator.msSaveOrOpenBlob) {
            window.navigator.msSaveBlob(blob, name);
        }
        else {
            let elem = window.document.createElement('a');
            elem.href = window.URL.createObjectURL(blob);
            elem.download = name;
            document.body.appendChild(elem);
            elem.click();
            document.body.removeChild(elem);
        }
    }

    function downloadAnnotations(websiteListId, googleCseId, googleCseCreatorId) {
        const ANNOTATION_SOURCES = ['include.txt', 'exclude.txt'];

        Promise.all(ANNOTATION_SOURCES.map(
            file => fetch(`websites/${websiteListId}/${file}`)
                .then(response => (response.status === 200) ? response.text() : '')
                .then(content => content))
        ).then(contents => {
            // TODO: Handle newline characters other than "\n"
            let tsvContent = 'URL\tLabel\n';
            tsvContent = tsvContent + contents[ANNOTATION_SOURCES.indexOf('include.txt')]
                .replace(/(.+)(\n|$)/g, `$1\t_cse_${googleCseId}$2`);
            tsvContent = tsvContent + contents[ANNOTATION_SOURCES.indexOf('exclude.txt')]
                .replace(/(.+)(\n|$)/g, `$1\t_cse_exclude_${googleCseId}$2`);
            downloadFile(`${websiteListId}-${new Date().toISOString().substring(0, 10)}.tsv`, tsvContent, 'text/csv');
        });
    }

    new Vue({
        el: '#websiteLists',
        data() {
            return {
                websiteLists: null
            }
        },
        mounted() {
            Promise.all(WEBSITES_METADATA.map(
                filename => fetch(filename)
                    .then(response => (response.status === 200) ? response.json() : [])
                    .then(content => content)
            )).then(websites => (this.websiteLists = [].concat(...websites)));
        }
    });
</script>
</body>
</html>