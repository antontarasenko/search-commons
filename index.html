<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Custom Search Lists</title>
</head>
<body>
<form id="search-form" onsubmit="return false;">
    <label for="query-string">Find</label>
    <input type="search" id="query-string" name="q">
    <label for="selected-engine">on</label>
    <select id="selected-engine" name="e"></select>
    <button type="submit">Search</button>
</form>
<div id="website-lists"></div>
<script>
    function loadSelectedEngineSelect(websiteList) {
        let selectedEngineSelect = document.getElementById('selected-engine');
        websiteList.forEach(function (websiteList) {
            let option = document.createElement('option');
            option.value = websiteList.googleCseCreatorId + ':' + websiteList.googleCseId;
            option.text = websiteList.name;
            selectedEngineSelect.appendChild(option);
        });
    }

    function loadWebsiteLists(websiteList) {
        let websiteListsElement = document.getElementById('website-lists');
        websiteList.forEach(function (websiteList) {
            let websiteListElement = document.createElement('div');
            websiteListElement.innerHTML =
                `<h2><a href="${websiteList.googleCseUrl}">${websiteList.name}</a></h2>` +
                `<h3>${websiteList.id}</h3>` +
                `<p>${websiteList.description}</p>` +
                `<p><a href="" onclick="downloadAnnotations('${websiteList.id}', '${websiteList.googleCseId}', '${websiteList.googleCseCreatorId}'); return false;">annotations.tsv</a></p>`;
            websiteListsElement.appendChild(websiteListElement);
        });
    }

    /**
     * Multi-browser file download solution from
     * https://stackoverflow.com/questions/3665115/
     * @param name
     * @param content
     * @param type
     */
    function downloadFile(name, content, type) {
        let blob = new Blob([content], {type: type});
        if (window.navigator.msSaveOrOpenBlob) {
            window.navigator.msSaveBlob(blob, name);
        }
        else {
            let elem = window.document.createElement('a');
            elem.href = window.URL.createObjectURL(blob);
            elem.download = name;
            document.body.appendChild(elem);
            elem.click();
            document.body.removeChild(elem);
        }
    }

    function downloadAnnotations(websiteListId, googleCseId, googleCseCreatorId) {
        const sourceFiles = ['include.txt', 'exclude.txt'];

        Promise.all(sourceFiles.map(
            file => fetch(`websites/${websiteListId}/${file}`)
                .then(response => (response.status === 200) ? response.text() : '')
                .then(content => content))
        ).then(contents => {
            // TODO: Handle newline characters other than "\n"
            let tsvContent = 'URL\tLabel\n';
            tsvContent = tsvContent + contents[sourceFiles.indexOf('include.txt')]
                .replace(/(.+)(\n|$)/g, `$1\t_cse_${googleCseId}$2`);
            tsvContent = tsvContent + contents[sourceFiles.indexOf('exclude.txt')]
                .replace(/(.+)(\n|$)/g, `$1\t_cse_exclude_${googleCseId}$2`);
            downloadFile('annotations.tsv', tsvContent, 'text/csv');
        });
    }

    document.addEventListener('DOMContentLoaded', function () {
        ['websitesLocal.json', 'websites.json'].forEach(file => fetch(file)
            .then(response => {
                if (response.ok) {
                    return response.json();
                } else {
                    throw new Error('File ignored: ' + file);
                }
            })
            .then(websiteLists => {
                websiteLists.forEach(list =>
                    list.googleCseUrl = `https://cse.google.com/cse?cx=${list.googleCseCreatorId}:${list.googleCseId}`
                );
                loadSelectedEngineSelect(websiteLists);
                loadWebsiteLists(websiteLists);
            })
            .catch(error => console.log(error))
        );
    });

    document.getElementById('search-form').addEventListener('submit', function (event) {
        const queryString = document.getElementById('query-string').value;
        const selectedEngine = document.getElementById('selected-engine').value;
        window.open(`https://cse.google.com/cse?cx=${selectedEngine}&q=${queryString}`);
    });
</script>
</body>
</html>